var map = L.map('mymap', {
  zoomSnap: 0.5
}).setView([45.2971, 5.7266], 9);

var
light = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  minZoom: 9,
  maxZoom: 18
}),
geom = {
  "type":"Polygon",
  "coordinates":[[[5.6237,45.6132],[5.6230,45.6042],[5.6430,45.5856],[5.6470,45.5767],[5.6548,45.5701],[5.6695,45.5631],[5.6803,45.5450],[5.6717,45.5365],[5.6768,45.5304],[5.6901,45.5280],[5.6912,45.5218],[5.7011,45.5175],[5.7026,45.5111],[5.712,45.5052],[5.7190,45.4842],[5.7363,45.4725],[5.732,45.4536],[5.7400,45.437],[5.7597,45.4352],[5.7634,45.4390],[5.7820,45.4406],[5.7979,45.4371],[5.8074,45.4262],[5.8232,45.4217],[5.8542,45.4165],[5.8607,45.4092],[5.8797,45.4067],[5.8917,45.3981],[5.8910,45.3922],[5.9096,45.39],[5.9149,45.4013],[5.9281,45.4154],[5.9226,45.4168],[5.9090,45.4082],[5.9016,45.4180],[5.9044,45.4325],[5.9149,45.4366],[5.9254,45.4645],[5.9164,45.476],[5.9533,45.484],[5.9661,45.4923],[5.9821,45.4870],[5.9893,45.4760],[6.0109,45.4732],[6.0085,45.4538],[6.0497,45.437],[6.0658,45.4441],[6.0909,45.4440],[6.0974,45.4321],[6.1212,45.4388],[6.13,45.433],[6.1436,45.4145],[6.1547,45.4093],[6.1774,45.3931],[6.1860,45.3743],[6.1916,45.3690],[6.1802,45.3604],[6.1803,45.3549],[6.194,45.3522],[6.1900,45.3424],[6.1844,45.3179],[6.1632,45.3128],[6.1417,45.2990],[6.1319,45.2882],[6.1325,45.2725],[6.139,45.2665],[6.1385,45.2560],[6.12,45.2442],[6.1272,45.2333],[6.1416,45.2223],[6.1378,45.2133],[6.1594,45.202],[6.1619,45.1884],[6.1437,45.1545],[6.1613,45.1510],[6.1690,45.1541],[6.1759,45.1623],[6.1892,45.163],[6.2159,45.1521],[6.2183,45.1453],[6.2277,45.1427],[6.2489,45.1496],[6.2653,45.1396],[6.260,45.1268],[6.2544,45.120],[6.2438,45.1172],[6.2293,45.108],[6.2296,45.1005],[6.2358,45.0872],[6.2401,45.0677],[6.220,45.065],[6.2063,45.0267],[6.2039,45.0124],[6.2517,44.99],[6.2696,44.9983],[6.2970,45.0033],[6.3182,45.0038],[6.3196,44.9945],[6.314,44.9801],[6.3285,44.9697],[6.3229,44.953],[6.3290,44.9473],[6.3588,44.9412],[6.3546,44.9235],[6.358,44.8937],[6.3507,44.8812],[6.3553,44.8547],[6.3363,44.848],[6.319,44.8568],[6.302,44.8732],[6.2882,44.8740],[6.2677,44.8695],[6.2581,44.8624],[6.2505,44.8526],[6.2243,44.8524],[6.1963,44.8589],[6.1852,44.8539],[6.1684,44.8522],[6.1490,44.858],[6.1362,44.8640],[6.1283,44.8619],[6.1166,44.8493],[6.1007,44.8425],[6.0965,44.8374],[6.0653,44.8226],[6.056,44.8159],[6.0402,44.8278],[6.0302,44.8380],[6.0159,44.8354],[6.004,44.8204],[5.9961,44.8178],[5.9781,44.8180],[5.9495,44.8045],[5.9537,44.7995],[5.9777,44.7909],[5.9801,44.7811],[5.9555,44.7724],[5.9524,44.7621],[5.9379,44.7630],[5.9268,44.7571],[5.9152,44.7547],[5.900,44.7583],[5.8888,44.7488],[5.8794,44.7470],[5.8652,44.7515],[5.8503,44.7507],[5.8371,44.7576],[5.8270,44.7596],[5.8277,44.7400],[5.8177,44.7304],[5.8087,44.7121],[5.801,44.7067],[5.7853,44.7008],[5.7590,44.6960],[5.7451,44.7037],[5.7417,44.7106],[5.7193,44.7137],[5.7052,44.7276],[5.6987,44.7220],[5.6682,44.7247],[5.6470,44.72],[5.6439,44.7315],[5.6315,44.7388],[5.6270,44.7524],[5.5899,44.7616],[5.5838,44.7653],[5.5820,44.7776],[5.5497,44.7945],[5.5441,44.7889],[5.5555,44.7712],[5.5196,44.777],[5.4949,44.7826],[5.464,44.7924],[5.4624,44.8026],[5.476,44.8090],[5.4767,44.8156],[5.4837,44.8231],[5.4637,44.8259],[5.4660,44.8412],[5.4750,44.8675],[5.4700,44.8790],[5.4803,44.8968],[5.4836,44.9222],[5.4776,44.9667],[5.4887,44.9902],[5.4884,45.0012],[5.4804,45.0138],[5.4836,45.0227],[5.4648,45.0459],[5.4662,45.0536],[5.4773,45.0720],[5.4888,45.0730],[5.482,45.0838],[5.4683,45.088],[5.4594,45.0843],[5.449,45.0707],[5.4257,45.0562],[5.4177,45.0483],[5.4088,45.0447],[5.3963,45.044],[5.3972,45.0383],[5.3883,45.0361],[5.371,45.0438],[5.3507,45.0472],[5.3437,45.0517],[5.3431,45.0597],[5.3347,45.0608],[5.3170,45.0514],[5.3074,45.0534],[5.3006,45.0625],[5.2918,45.0639],[5.2662,45.0598],[5.2483,45.0609],[5.2445,45.0669],[5.2303,45.07],[5.2261,45.0791],[5.2082,45.084],[5.1833,45.0848],[5.1793,45.0833],[5.1634,45.0659],[5.147,45.0725],[5.1427,45.080],[5.15,45.0827],[5.1628,45.0984],[5.1763,45.1078],[5.1874,45.1208],[5.1868,45.1451],[5.19,45.1545],[5.1885,45.1712],[5.1770,45.1797],[5.1694,45.1952],[5.1648,45.1984],[5.1674,45.2102],[5.1787,45.2169],[5.2017,45.21],[5.1853,45.230],[5.1765,45.2483],[5.1566,45.2473],[5.1519,45.255],[5.1414,45.2450],[5.1314,45.2433],[5.1214,45.2483],[5.1256,45.2620],[5.1301,45.2672],[5.1313,45.2865],[5.1385,45.2962],[5.1255,45.2985],[5.1122,45.2897],[5.0910,45.286],[5.0754,45.2818],[5.0591,45.3136],[5.0543,45.3190],[5.0205,45.3194],[5.009,45.342],[4.9891,45.3440],[4.9595,45.3289],[4.9475,45.3285],[4.9284,45.3229],[4.9012,45.3100],[4.8802,45.2974],[4.858,45.2985],[4.8588,45.3089],[4.800,45.2983],[4.7889,45.3067],[4.7699,45.3160],[4.7605,45.327],[4.7613,45.3406],[4.7736,45.3476],[4.7725,45.3548],[4.7,45.3656],[4.759,45.3814],[4.7558,45.3964],[4.7441,45.4088],[4.7447,45.4213],[4.7586,45.4310],[4.7604,45.4370],[4.7555,45.4470],[4.7569,45.4557],[4.7794,45.4550],[4.782,45.4722],[4.8120,45.4833],[4.8272,45.4962],[4.841,45.5006],[4.8684,45.5234],[4.8728,45.5313],[4.8644,45.5373],[4.8401,45.5432],[4.8311,45.5477],[4.8086,45.5723],[4.7820,45.5805],[4.7771,45.5873],[4.8034,45.5875],[4.8100,45.5895],[4.8577,45.5795],[4.8597,45.5908],[4.8729,45.5953],[4.8821,45.6015],[4.8927,45.6015],[4.9014,45.6062],[4.927,45.6057],[4.9360,45.6088],[4.9603,45.6100],[4.9719,45.6126],[4.997,45.603],[5.001,45.6139],[4.9894,45.6185],[5.0047,45.6231],[5.0380,45.6150],[5.0436,45.6213],[5.0351,45.6372],[5.0445,45.6472],[5.0580,45.6532],[5.0542,45.6601],[5.077,45.6746],[5.0888,45.6770],[5.0942,45.6828],[5.1081,45.6880],[5.1048,45.7003],[5.119,45.6997],[5.1310,45.7077],[5.1430,45.7000],[5.1592,45.7145],[5.1481,45.7187],[5.1339,45.7332],[5.1226,45.7378],[5.0945,45.7394],[5.089,45.7496],[5.0930,45.7660],[5.0701,45.7654],[5.0595,45.7825],[5.0611,45.7915],[5.0893,45.7842],[5.1010,45.8133],[5.1053,45.8084],[5.1255,45.8110],[5.1441,45.8045],[5.1603,45.8023],[5.1768,45.7934],[5.186,45.7820],[5.191,45.7716],[5.2076,45.7718],[5.2210,45.7684],[5.2668,45.7893],[5.2755,45.8008],[5.288,45.8111],[5.2906,45.820],[5.2998,45.8373],[5.3023,45.8479],[5.3091,45.8549],[5.3299,45.86],[5.3409,45.8805],[5.3538,45.883],[5.3709,45.8749],[5.3809,45.8672],[5.4131,45.8522],[5.4190,45.8396],[5.4349,45.8310],[5.4204,45.8188],[5.4226,45.8071],[5.4574,45.7809],[5.4825,45.7545],[5.5185,45.7301],[5.5272,45.7155],[5.5455,45.7135],[5.5534,45.7089],[5.5551,45.7002],[5.5711,45.6968],[5.5757,45.6917],[5.5703,45.6844],[5.561,45.6869],[5.5559,45.6976],[5.5459,45.6973],[5.5451,45.68],[5.5527,45.6798],[5.5541,45.6717],[5.5638,45.6741],[5.5867,45.6652],[5.6030,45.6476],[5.6069,45.6354],[5.6237,45.6132]]]
},
boundaryLayer = L.TileLayer.BoundaryCanvas.createFromLayer(light, {
  boundary: geom,
  trackAttribution: true
}).addTo(map);



var popmaps = function(feature, layer) {
  var prop = feature.properties,
    popUp = '<h2>' + prop.title + '</h2>' +
    '<div class="desc">' + (prop.description || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>') + '</div>' +
    '<div class="num">' + (prop.phone || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>').replace(/(?:\+33|0)([0-9 ]{3,})/g, '<a href="tel:+33$1">0$1</a>').replace(/0([0-9])([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{2})/g, '0$1 $2 $3 $4 $5') + '</div>' +
    '<div class="mail">' + (prop.email || '').replace(/([A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,})/gi, '<a href="mailto:$1">$1</a>') + '</div>' +
    '<div class="web">' + (prop.url || '').replace(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/gi, '<a href="$1">$1</a>') + '</div>' +
    '<div class="loc">' + (prop.address || '') + '</div>' +
    '<div class="bus">' + (prop.bus || '') + '</div>' +
    '<div class="park">' + (prop.park || '') + '</div>' +
    '<div class="acc">' + (prop.accessible || '') + '</div>' +
    '<div class="fb">' + (prop.facebook || '').replace(/(?:https?:\/\/www\.facebook\.com\/)?@?([a-zé_0-9-.]+)\/?/gi, '<a href="https://www.facebook.com/$1">@$1</a>') + '</div>' +
    '<div class="tw">' + (prop.twitter || '').replace(/(?:https?:\/\/www\.twitter\.com\/)?@?([a-z_0-9-.]+)\/?/gi, '<a href="https://www.twitter.com/$1">@$1</a>') + '</div>' +
    '<div class="ig">' + (prop.instagram || '').replace(/(?:https?:\/\/www\.instagram\.com\/)?@?([a-z_0-9-.]+)\/?/gi, '<a href="https://www.instagram.com/$1">@$1</a>') + '</div>' +
    '<div class="yt">' + (prop.youtube || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>') + '</div>' +
    '<div class="sc">' + (prop.soundcloud || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>') + '</div>' +
    '<div class="prix">' + (prop.prix || '') + '</div>' +
    '<div class="conv">' + (prop.conv || '') + '</div>' +
    '<div class="lng">' + (prop.language || '') + '</div>' +
    '<div class="info">' + (prop.info || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>') + '</div>' +
    '<div class="avis">' + (prop.avis || '').replace(/\[\[(.+?)\|(.+?)\]\]/gi, '<a href="$1">$2</a>') + '</div>';
  layer.bindPopup(String(popUp));
},
main = L.geoJson(geojson, {
  pointToLayer: function(feature, latlng) {
    var icon = L.divIcon({
      iconSize: [35,35],
      iconAnchor: [17,35],
      className: 'm-' + (feature.properties.category || "default"),
      popupAnchor: [0,0],
      html: '<div class="marker-pin"></div><div class="shadow"></div>'
    });
    return L.marker(latlng, {
      icon: icon,
      riseOnHover: true
    });
  },
  onEachFeature: popmaps
}).addTo(map);

var command = L.control({position: 'topright'});

command.onAdd = function() {
  var div = L.DomUtil.create('div', 'command');
  div.innerHTML += '<h3>Filtrer</h3>'
  + '<label for="exit-command" class="lab"><input type="checkbox" id="exit-command" /></label>'
  + '<label for="m-menses"><input id="m-menses" type="checkbox" class="chk-filter" checked />Boîtes à don menstruelles</label>'
  + '<label for="m-host"><input id="m-host" type="checkbox" class="chk-filter" checked />Hébergement</label>'
  + '<label for="m-testing"><input id="m-testing" type="checkbox" class="chk-filter" checked />Dépistage IST</label>'
  + '<label for="m-doctor"><input id="m-doctor" type="checkbox" class="chk-filter" checked />Soignant&middot;es</label>'
  + '<label for="m-sport"><input id="m-sport" type="checkbox" class="chk-filter" checked />Sport</label>'
  + '<label for="m-activism"><input id="m-activism" type="checkbox" class="chk-filter" checked />Militer</label>'
  + '<label for="m-health"><input id="m-health" type="checkbox" class="chk-filter" checked />Santé</label>'
  + '<label for="m-culture"><input id="m-culture" type="checkbox" class="chk-filter" checked />Culturel</label>'
  + '<label for="m-support"><input id="m-support" type="checkbox" class="chk-filter" checked />Groupe de parole</label>'
  + '<label for="m-official"><input id="m-official" type="checkbox" class="chk-filter" checked />Élues</label>'
  + '<label for="m-solidarity"><input id="m-solidarity" type="checkbox" class="chk-filter" checked />Solidarité</label>'
  + '<label for="m-right"><input id="m-right" type="checkbox" class="chk-filter" checked />Droit & Justice</label>'
  return div;
};
command.addTo(map);

document.addEventListener('click', (e) => {
  if ('chk-filter' == e.target.className) {
    var el = document.getElementsByClassName(e.target.id);
    if (e.target.checked) {
      [...el].forEach(x => (x.style.display = 'block'));
    } else {
      [...el].forEach(x => (x.style.display = 'none'));
    }
  }
  if ('exit-command' == e.target.id) {
    document.querySelector('.command').classList.toggle('hide')
    document.querySelector('.lab').classList.toggle('down')
  }
}, false);
